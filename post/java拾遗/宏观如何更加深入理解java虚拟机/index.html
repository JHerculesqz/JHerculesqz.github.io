<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>【宏观】如何更加深入理解Java虚拟机 - 妙木山</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="猴王无敌"><meta name=description content="1.深入理解JVM——那还是别人的故事 国庆期间，思考了一个问题：怎样才算深入理解了Java虚拟机？ 把周志明的《深入理解Java虚拟机》看5遍"><meta name=keywords content="Hugo,theme,jane"><meta name=generator content="Hugo 0.74.2"><link rel=canonical href=https://jherculesqz.github.io/post/java%E6%8B%BE%E9%81%97/%E5%AE%8F%E8%A7%82%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css integrity="sha256-s6iBPAbm14W+uiK/gmThdPoss6OWsi+bok4sAMGKr38=" media=screen crossorigin=anonymous><meta property="og:title" content="【宏观】如何更加深入理解Java虚拟机"><meta property="og:description" content="1.深入理解JVM——那还是别人的故事 国庆期间，思考了一个问题：怎样才算深入理解了Java虚拟机？ 把周志明的《深入理解Java虚拟机》看5遍"><meta property="og:type" content="article"><meta property="og:url" content="https://jherculesqz.github.io/post/java%E6%8B%BE%E9%81%97/%E5%AE%8F%E8%A7%82%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/"><meta property="article:published_time" content="2021-10-12T23:39:00+08:00"><meta property="article:modified_time" content="2021-10-12T23:39:00+08:00"><meta itemprop=name content="【宏观】如何更加深入理解Java虚拟机"><meta itemprop=description content="1.深入理解JVM——那还是别人的故事 国庆期间，思考了一个问题：怎样才算深入理解了Java虚拟机？ 把周志明的《深入理解Java虚拟机》看5遍"><meta itemprop=datePublished content="2021-10-12T23:39:00+08:00"><meta itemprop=dateModified content="2021-10-12T23:39:00+08:00"><meta itemprop=wordCount content="3553"><meta itemprop=keywords content="Java拾遗-宏观,"><meta name=twitter:card content="summary"><meta name=twitter:title content="【宏观】如何更加深入理解Java虚拟机"><meta name=twitter:description content="1.深入理解JVM——那还是别人的故事 国庆期间，思考了一个问题：怎样才算深入理解了Java虚拟机？ 把周志明的《深入理解Java虚拟机》看5遍"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>妙木山</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=https://jherculesqz.github.io/>首页</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://jherculesqz.github.io/categories/>技术专栏</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://jherculesqz.github.io/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://jherculesqz.github.io/post/>全部文章</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://jherculesqz.github.io/about/>关于</a></li></ul></nav><link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css><link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header id=header class="header container"><div class=logo-wrapper><a href=/ class=logo>妙木山</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=https://jherculesqz.github.io/>首页</a></li><li class=menu-item><a class=menu-item-link href=https://jherculesqz.github.io/categories/>技术专栏</a></li><li class=menu-item><a class=menu-item-link href=https://jherculesqz.github.io/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=https://jherculesqz.github.io/post/>全部文章</a></li><li class=menu-item><a class=menu-item-link href=https://jherculesqz.github.io/about/>关于</a></li></ul></nav></header><div id=mobile-panel><main id=main class="main bg-llight"><div class=content-wrapper><div id=content class="content container"><article class="post bg-white"><header class=post-header><h1 class=post-title>【宏观】如何更加深入理解Java虚拟机</h1><div class=post-meta><time datetime=2021-10-12 class=post-time>2021-10-12</time><div class=post-category><a href=https://jherculesqz.github.io/categories/java%E6%8B%BE%E9%81%97/>Java拾遗</a></div><span class=more-meta>约 3553 字</span>
<span class=more-meta>预计阅读 8 分钟</span>
<span id=busuanzi_container_page_pv>| 阅读 <span id=busuanzi_value_page_pv></span></span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#1深入理解jvm那还是别人的故事>1.深入理解JVM——那还是别人的故事</a></li><li><a href=#2阅读openjdk源码从这里开始>2.阅读OpenJDK源码，从这里开始</a></li><li><a href=#3javac的入口解读>3.javac的入口解读</a><ul><li><a href=#31langtoolssrcshareclassescomsuntoolsjavacmainjava>3.1.langtools/src/share/classes/com/sun/tools/javac/Main.java</a><ul><li><a href=#类结构>类结构</a></li><li><a href=#与周边类的关系>与周边类的关系</a></li></ul></li><li><a href=#32langtoolssrcshareclassescomsuntoolsjavacmainmainjava>3.2.langtools/src/share/classes/com/sun/tools/javac/main/Main.java</a><ul><li><a href=#类的属性>类的属性</a></li><li><a href=#类的行为>类的行为</a></li><li><a href=#与周边类的关系-1>与周边类的关系</a></li></ul></li></ul></li><li><a href=#4总结>4.总结</a></li></ul></nav></div></div><div class=post-content><h1 id=1深入理解jvm那还是别人的故事>1.深入理解JVM——那还是别人的故事</h1><p>国庆期间，思考了一个问题：<code>怎样才算深入理解了Java虚拟机？</code></p><p>把周志明的《深入理解Java虚拟机》看5遍算不算透彻理解了JVM？</p><p>似乎不算：笔者已经阅读过好几遍，其中部分章节应该超过5遍。但，依然觉得很多技术点如同罩上了一层薄纱。</p><p>为什么会这样呢？</p><p>如果把《Java语言规范》和《Java虚拟机规范》看作是JDK和JVM的需求说明书，那么《深入理解Java虚拟机》就相当于周志明老师梳理总结的JDK和JVM的规格说明书。</p><p>这是一种娓娓道来的<code>知识论述</code>，即JVM的知识本身已经是客观存在，作者会摆出他的<code>MainIdea</code>和<code>Support Idea</code>，而后通过<code>事实</code>和<code>例子</code>事实进行<code>推理</code>，进而证明作者对JVM的规格理解的正确性和逻辑自洽性。</p><p>然而，无论马可波罗讲故事的能力有多强，他描述的神秘东方始终是他看到的客观存在。</p><p>因此，如果我没有亲自阅读JDK和JVM的源码，那还是别人的故事。</p><p><img src=/Java%E6%8B%BE%E9%81%97/%E3%80%90%E5%AE%8F%E8%A7%82%E3%80%91%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20211012225213714.png alt=image-20211012225213714></p><h1 id=2阅读openjdk源码从这里开始>2.阅读OpenJDK源码，从这里开始</h1><p>下载了OpenJDK 8的源码，您会面对着海量的代码，不知如何入手。</p><p><img src=/Java%E6%8B%BE%E9%81%97/%E3%80%90%E5%AE%8F%E8%A7%82%E3%80%91%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20211012230038531.png alt=image-20211012230038531></p><p>笔者认为，不如想想JVM的体系结构：</p><p><img src=/Java%E6%8B%BE%E9%81%97/%E3%80%90%E5%AE%8F%E8%A7%82%E3%80%91%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20211012225535950.png alt=image-20211012225535950></p><p>JVM体系中，第一个环节是将<code>源代码(.java)</code>变成<code>字节码(.class)</code>，也就是说<code>前端编译器(javac)</code>承载了《Java语言规范》和《Java虚拟机规范》中大部分的规格。</p><p>至少，可以认为，阅读<code>前端编译器(javac)</code>的源码，可以理解编译期的静态行为。</p><p>从javac对应的源码看，也的确如此：</p><ul><li>comp包中可以看到语义分析、数据流分析、语法糖擦除、泛型擦除等代码</li></ul><p><img src=/Java%E6%8B%BE%E9%81%97/%E3%80%90%E5%AE%8F%E8%A7%82%E3%80%91%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20211012230328641.png alt=image-20211012230328641></p><ul><li>jvm包可以看到从AST树生成字节码的代码</li></ul><p><img src=/Java%E6%8B%BE%E9%81%97/%E3%80%90%E5%AE%8F%E8%A7%82%E3%80%91%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20211012230413468.png alt=image-20211012230413468></p><ul><li>parser包可以看到词法分析生成TokenQueue的代码</li></ul><p><img src=/Java%E6%8B%BE%E9%81%97/%E3%80%90%E5%AE%8F%E8%A7%82%E3%80%91%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20211012230441083.png alt=image-20211012230441083></p><p>上述三点，基本就覆盖了《Java语言规范》的大部分内容，也覆盖了《Java虚拟机规范》中关于字节码规格的大部分内容。</p><h1 id=3javac的入口解读>3.javac的入口解读</h1><h2 id=31langtoolssrcshareclassescomsuntoolsjavacmainjava>3.1.langtools/src/share/classes/com/sun/tools/javac/Main.java</h2><p>这是javac的入口类，代码结构很简单</p><h3 id=类结构>类结构</h3><blockquote><p>这个类仅有3个方法，main函数调用了compile函数</p></blockquote><p><img src=/Java%E6%8B%BE%E9%81%97/%E3%80%90%E5%AE%8F%E8%A7%82%E3%80%91%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20211012230802827.png alt=image-20211012230802827></p><h3 id=与周边类的关系>与周边类的关系</h3><blockquote><p>在Main#compile()函数中，又去调用了<code> com/sun/tools/javac/main/Main.java</code></p></blockquote><p><img src=/Java%E6%8B%BE%E9%81%97/%E3%80%90%E5%AE%8F%E8%A7%82%E3%80%91%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20211012230924610.png alt=image-20211012230924610></p><h2 id=32langtoolssrcshareclassescomsuntoolsjavacmainmainjava>3.2.langtools/src/share/classes/com/sun/tools/javac/main/Main.java</h2><p>这个类承载了javac真正开始干活儿的流程，代码略多，我们从<code>类的属性</code>、<code>类的行为</code>、<code>与周边类的关系</code>来剖析它。</p><h3 id=类的属性>类的属性</h3><p>笔者只在此列举几个重要的属性，其它的属性可以到<code>https://github.com/JHerculesqz/jdk8</code>上找到笔者详细标注的注释说明。</p><blockquote><p>recognizedOptions：这是一个Option数组，每个Option元素可以认为是javac后面命令行配置参数。这个数组记录了javac内置的合法的命令行参数。</p><p>optionHelper：这是OptionHelper这个抽象类的具体实现类，它的主要职责就是维护用户实际在javac后面输入的命令行参数。</p><p>filenames：维护了用户在javac后面输入的待编译的.java源文件。</p><p>fileManager：javac内置的一个文件管理模块，负责对待编译的.java源文件进行处理。</p></blockquote><p><img src=/Java%E6%8B%BE%E9%81%97/%E3%80%90%E5%AE%8F%E8%A7%82%E3%80%91%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20211012231318310.png alt=image-20211012231318310></p><h3 id=类的行为>类的行为</h3><p>除了compile方法、processArgs方法，其它都属于打辅助的方法(如：bugMessge方法就是对log对象进行了封装，用于记录错误日志)，这些辅助方法笔者就不在此赘述了，依然可以参考<code>https://github.com/JHerculesqz/jdk8</code>上笔者详细标注的注释说明。</p><p><img src=/Java%E6%8B%BE%E9%81%97/%E3%80%90%E5%AE%8F%E8%A7%82%E3%80%91%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20211012231906655.png alt=image-20211012231906655></p><p>我们在此稍微展开一下compile方法的细节：</p><p><img src=/Java%E6%8B%BE%E9%81%97/%E3%80%90%E5%AE%8F%E8%A7%82%E3%80%91%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20211012232303828.png alt=image-20211012232303828></p><p>我们可以将这个方法拆分为3段：</p><ul><li>前戏：初始化Main中的各个成员对象。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=n>Result</span> <span class=nf>compile</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>,</span>
                      <span class=n>String</span><span class=o>[]</span> <span class=n>classNames</span><span class=o>,</span>
                      <span class=n>Context</span> <span class=n>context</span><span class=o>,</span>
                      <span class=n>List</span><span class=o>&lt;</span><span class=n>JavaFileObject</span><span class=o>&gt;</span> <span class=n>fileObjects</span><span class=o>,</span>
                      <span class=n>Iterable</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Processor</span><span class=o>&gt;</span> <span class=n>processors</span><span class=o>)</span>
<span class=o>{</span>
    <span class=c1>//HCZ：前戏：在上下文对象中塞out对象，初始化log对象、options对象、fileNames、classnames
</span><span class=c1></span>    <span class=n>context</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>Log</span><span class=o>.</span><span class=na>outKey</span><span class=o>,</span> <span class=n>out</span><span class=o>);</span>
    <span class=n>log</span> <span class=o>=</span> <span class=n>Log</span><span class=o>.</span><span class=na>instance</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>

    <span class=k>if</span> <span class=o>(</span><span class=n>options</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
        <span class=n>options</span> <span class=o>=</span> <span class=n>Options</span><span class=o>.</span><span class=na>instance</span><span class=o>(</span><span class=n>context</span><span class=o>);</span> <span class=c1>// creates a new one
</span><span class=c1></span>
    <span class=n>filenames</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;();</span>
    <span class=n>classnames</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ListBuffer</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;();</span>
    <span class=n>JavaCompiler</span> <span class=n>comp</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
    
    <span class=err>…………</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><ul><li>命令行参数处理：调用Main#processsArgs方法，处理javac后面的命令行参数</li></ul><p>注意：这里有一些高级技术细节，当前不必深入其中，在展开这些高级技术细节时可以再来展开这部分源码。</p><blockquote><p>比如：JVM支持我们自己实现javac的插件，这里插件生命周期的初始化部分就在这段代码中。</p><p>比如：javac在关闭nonBatchMode模式后，启用编译缓存，也在这段代码中。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=n>Result</span> <span class=nf>compile</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>,</span>
                      <span class=n>String</span><span class=o>[]</span> <span class=n>classNames</span><span class=o>,</span>
                      <span class=n>Context</span> <span class=n>context</span><span class=o>,</span>
                      <span class=n>List</span><span class=o>&lt;</span><span class=n>JavaFileObject</span><span class=o>&gt;</span> <span class=n>fileObjects</span><span class=o>,</span>
                      <span class=n>Iterable</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Processor</span><span class=o>&gt;</span> <span class=n>processors</span><span class=o>)</span>
<span class=o>{</span>
    <span class=err>…………</span>
    <span class=cm>/*
</span><span class=cm>         * TODO: Logic below about what is an acceptable command line
</span><span class=cm>         * should be updated to take annotation processing semantics
</span><span class=cm>         * into account.
</span><span class=cm>         */</span>
    <span class=k>try</span> <span class=o>{</span>
        <span class=c1>//HCZ：如果各种不合法，返回编译错误，并告知记得敲一下-help
</span><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>args</span><span class=o>.</span><span class=na>length</span> <span class=o>==</span> <span class=n>0</span>
            <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>classNames</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>classNames</span><span class=o>.</span><span class=na>length</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span>
            <span class=o>&amp;&amp;</span> <span class=n>fileObjects</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
            <span class=n>Option</span><span class=o>.</span><span class=na>HELP</span><span class=o>.</span><span class=na>process</span><span class=o>(</span><span class=n>optionHelper</span><span class=o>,</span> <span class=s>&#34;-help&#34;</span><span class=o>);</span>
            <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>CMDERR</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=n>Collection</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=n>files</span><span class=o>;</span>
        <span class=k>try</span> <span class=o>{</span>
            <span class=c1>//HCZ：调用Main#processArgs，获得命令行参数中的.java文件对象列表
</span><span class=c1></span>            <span class=n>files</span> <span class=o>=</span> <span class=n>processArgs</span><span class=o>(</span><span class=n>CommandLine</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>args</span><span class=o>),</span> <span class=n>classNames</span><span class=o>);</span>
            <span class=c1>//HCZ：Main#processArgs竟然返回了null？，返回错误信息
</span><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>files</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// null signals an error in options, abort
</span><span class=c1></span>                <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>CMDERR</span><span class=o>;</span>
            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>files</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>fileObjects</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>classnames</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
                <span class=c1>// it is allowed to compile nothing if just asking for help or version info
</span><span class=c1></span>                <span class=c1>//HCZ：文件列表是Empty，说明可能是javac --help/-X/-version/-fullversion，则返回正确
</span><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>options</span><span class=o>.</span><span class=na>isSet</span><span class=o>(</span><span class=n>HELP</span><span class=o>)</span>
                    <span class=o>||</span> <span class=n>options</span><span class=o>.</span><span class=na>isSet</span><span class=o>(</span><span class=n>X</span><span class=o>)</span>
                    <span class=o>||</span> <span class=n>options</span><span class=o>.</span><span class=na>isSet</span><span class=o>(</span><span class=n>VERSION</span><span class=o>)</span>
                    <span class=o>||</span> <span class=n>options</span><span class=o>.</span><span class=na>isSet</span><span class=o>(</span><span class=n>FULLVERSION</span><span class=o>))</span>
                    <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>OK</span><span class=o>;</span>
                <span class=k>if</span> <span class=o>(</span><span class=n>JavaCompiler</span><span class=o>.</span><span class=na>explicitAnnotationProcessingRequested</span><span class=o>(</span><span class=n>options</span><span class=o>))</span> <span class=o>{</span>
                    <span class=c1>//HCZ:还不太懂？
</span><span class=c1></span>                    <span class=n>error</span><span class=o>(</span><span class=s>&#34;err.no.source.files.classes&#34;</span><span class=o>);</span>
                <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
                    <span class=c1>//HCZ:又不是-help这种参数配置，说明用户输入错了，返回错误
</span><span class=c1></span>                    <span class=n>error</span><span class=o>(</span><span class=s>&#34;err.no.source.files&#34;</span><span class=o>);</span>
                <span class=o>}</span>
                <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>CMDERR</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>FileNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=c1>//HCZ：指定的文件找不到，则返回错误
</span><span class=c1></span>            <span class=n>warning</span><span class=o>(</span><span class=s>&#34;err.file.not.found&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
            <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>SYSERR</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=c1>//HCZ：如果指定了stdout，清一下log对象，重定向到System.out上
</span><span class=c1></span>        <span class=kt>boolean</span> <span class=n>forceStdOut</span> <span class=o>=</span> <span class=n>options</span><span class=o>.</span><span class=na>isSet</span><span class=o>(</span><span class=s>&#34;stdout&#34;</span><span class=o>);</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>forceStdOut</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>log</span><span class=o>.</span><span class=na>flush</span><span class=o>();</span>
            <span class=n>log</span><span class=o>.</span><span class=na>setWriters</span><span class=o>(</span><span class=k>new</span> <span class=n>PrintWriter</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>,</span> <span class=kc>true</span><span class=o>));</span>
        <span class=o>}</span>

        <span class=c1>//HCZ：如果没有设置nonBatchMode，则在上下文对象中创建CacheFSInfo对象，用于多次编译时的缓存。
</span><span class=c1></span>        <span class=c1>// allow System property in following line as a Mustang legacy
</span><span class=c1></span>        <span class=kt>boolean</span> <span class=n>batchMode</span> <span class=o>=</span> <span class=o>(</span><span class=n>options</span><span class=o>.</span><span class=na>isUnset</span><span class=o>(</span><span class=s>&#34;nonBatchMode&#34;</span><span class=o>)</span>
                             <span class=o>&amp;&amp;</span> <span class=n>System</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=s>&#34;nonBatchMode&#34;</span><span class=o>)</span> <span class=o>==</span> <span class=kc>null</span><span class=o>);</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>batchMode</span><span class=o>)</span>
            <span class=n>CacheFSInfo</span><span class=o>.</span><span class=na>preRegister</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>

        <span class=c1>// FIXME: this code will not be invoked if using JavacTask.parse/analyze/generate
</span><span class=c1></span>        <span class=c1>// invoke any available plugins
</span><span class=c1></span>        <span class=c1>//HCZ：如果存在javac的插件，则...
</span><span class=c1></span>        <span class=c1>//啥是javac插件？参考：https://www.baeldung.com/java-build-compiler-plugin
</span><span class=c1></span>        <span class=c1>//？待研究：如下初始化javac插件的逻辑细节。
</span><span class=c1></span>        <span class=n>String</span> <span class=n>plugins</span> <span class=o>=</span> <span class=n>options</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>PLUGIN</span><span class=o>);</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>plugins</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>JavacProcessingEnvironment</span> <span class=n>pEnv</span> <span class=o>=</span> <span class=n>JavacProcessingEnvironment</span><span class=o>.</span><span class=na>instance</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
            <span class=n>ClassLoader</span> <span class=n>cl</span> <span class=o>=</span> <span class=n>pEnv</span><span class=o>.</span><span class=na>getProcessorClassLoader</span><span class=o>();</span>
            <span class=n>ServiceLoader</span><span class=o>&lt;</span><span class=n>Plugin</span><span class=o>&gt;</span> <span class=n>sl</span> <span class=o>=</span> <span class=n>ServiceLoader</span><span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>Plugin</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>cl</span><span class=o>);</span>
            <span class=n>Set</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span> <span class=n>pluginsToCall</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;();</span>
            <span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>plugin</span><span class=o>:</span> <span class=n>plugins</span><span class=o>.</span><span class=na>split</span><span class=o>(</span><span class=s>&#34;\\x00&#34;</span><span class=o>))</span> <span class=o>{</span>
                <span class=n>pluginsToCall</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>List</span><span class=o>.</span><span class=na>from</span><span class=o>(</span><span class=n>plugin</span><span class=o>.</span><span class=na>split</span><span class=o>(</span><span class=s>&#34;\\s+&#34;</span><span class=o>)));</span>
            <span class=o>}</span>
            <span class=n>JavacTask</span> <span class=n>task</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
            <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>Plugin</span><span class=o>&gt;</span> <span class=n>iter</span> <span class=o>=</span> <span class=n>sl</span><span class=o>.</span><span class=na>iterator</span><span class=o>();</span>
            <span class=k>while</span> <span class=o>(</span><span class=n>iter</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
                <span class=n>Plugin</span> <span class=n>plugin</span> <span class=o>=</span> <span class=n>iter</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
                <span class=k>for</span> <span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>p</span><span class=o>:</span> <span class=n>pluginsToCall</span><span class=o>)</span> <span class=o>{</span>
                    <span class=k>if</span> <span class=o>(</span><span class=n>plugin</span><span class=o>.</span><span class=na>getName</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>p</span><span class=o>.</span><span class=na>head</span><span class=o>))</span> <span class=o>{</span>
                        <span class=n>pluginsToCall</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>p</span><span class=o>);</span>
                        <span class=k>try</span> <span class=o>{</span>
                            <span class=k>if</span> <span class=o>(</span><span class=n>task</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
                                <span class=n>task</span> <span class=o>=</span> <span class=n>JavacTask</span><span class=o>.</span><span class=na>instance</span><span class=o>(</span><span class=n>pEnv</span><span class=o>);</span>
                            <span class=n>plugin</span><span class=o>.</span><span class=na>init</span><span class=o>(</span><span class=n>task</span><span class=o>,</span> <span class=n>p</span><span class=o>.</span><span class=na>tail</span><span class=o>.</span><span class=na>toArray</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>p</span><span class=o>.</span><span class=na>tail</span><span class=o>.</span><span class=na>size</span><span class=o>()]));</span>
                        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
                            <span class=k>if</span> <span class=o>(</span><span class=n>apiMode</span><span class=o>)</span>
                                <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
                            <span class=n>pluginMessage</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
                            <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>SYSERR</span><span class=o>;</span>
                        <span class=o>}</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span>
            <span class=k>for</span> <span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>p</span><span class=o>:</span> <span class=n>pluginsToCall</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>log</span><span class=o>.</span><span class=na>printLines</span><span class=o>(</span><span class=n>PrefixKind</span><span class=o>.</span><span class=na>JAVAC</span><span class=o>,</span> <span class=s>&#34;msg.plugin.not.found&#34;</span><span class=o>,</span> <span class=n>p</span><span class=o>.</span><span class=na>head</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=o>}</span>
        
    <span class=err>…………</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><ul><li>调用JavaComplier#compile，进行真正的.java到.class的编译</li></ul><blockquote><p>说明：这里也可以跳过xdoclint的代码。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=n>Result</span> <span class=nf>compile</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>,</span>
                      <span class=n>String</span><span class=o>[]</span> <span class=n>classNames</span><span class=o>,</span>
                      <span class=n>Context</span> <span class=n>context</span><span class=o>,</span>
                      <span class=n>List</span><span class=o>&lt;</span><span class=n>JavaFileObject</span><span class=o>&gt;</span> <span class=n>fileObjects</span><span class=o>,</span>
                      <span class=n>Iterable</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Processor</span><span class=o>&gt;</span> <span class=n>processors</span><span class=o>)</span>
<span class=o>{</span>
    <span class=err>…………</span>
        <span class=c1>//HCZ：初始化JavaCompiler
</span><span class=c1></span>        <span class=n>comp</span> <span class=o>=</span> <span class=n>JavaCompiler</span><span class=o>.</span><span class=na>instance</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>

        <span class=c1>// FIXME: this code will not be invoked if using JavacTask.parse/analyze/generate
</span><span class=c1></span>        <span class=c1>//HCZ：xdoclint相关
</span><span class=c1></span>        <span class=c1>//待研究：如下xdoclint的各种初始化细节
</span><span class=c1></span>        <span class=n>String</span> <span class=n>xdoclint</span> <span class=o>=</span> <span class=n>options</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>XDOCLINT</span><span class=o>);</span>
        <span class=n>String</span> <span class=n>xdoclintCustom</span> <span class=o>=</span> <span class=n>options</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>XDOCLINT_CUSTOM</span><span class=o>);</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>xdoclint</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>xdoclintCustom</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>doclintOpts</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;();</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>xdoclint</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
                <span class=n>doclintOpts</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>DocLint</span><span class=o>.</span><span class=na>XMSGS_OPTION</span><span class=o>);</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>xdoclintCustom</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
                <span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>s</span><span class=o>:</span> <span class=n>xdoclintCustom</span><span class=o>.</span><span class=na>split</span><span class=o>(</span><span class=s>&#34;\\s+&#34;</span><span class=o>))</span> <span class=o>{</span>
                    <span class=k>if</span> <span class=o>(</span><span class=n>s</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span>
                        <span class=k>continue</span><span class=o>;</span>
                    <span class=n>doclintOpts</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>s</span><span class=o>.</span><span class=na>replace</span><span class=o>(</span><span class=n>XDOCLINT_CUSTOM</span><span class=o>.</span><span class=na>text</span><span class=o>,</span> <span class=n>DocLint</span><span class=o>.</span><span class=na>XMSGS_CUSTOM_PREFIX</span><span class=o>));</span>
                <span class=o>}</span>
            <span class=o>}</span>
            <span class=k>if</span> <span class=o>(!(</span><span class=n>doclintOpts</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>==</span> <span class=n>1</span>
                  <span class=o>&amp;&amp;</span> <span class=n>doclintOpts</span><span class=o>.</span><span class=na>iterator</span><span class=o>().</span><span class=na>next</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>DocLint</span><span class=o>.</span><span class=na>XMSGS_CUSTOM_PREFIX</span> <span class=o>+</span> <span class=s>&#34;none&#34;</span><span class=o>)))</span> <span class=o>{</span>
                <span class=n>JavacTask</span> <span class=n>t</span> <span class=o>=</span> <span class=n>BasicJavacTask</span><span class=o>.</span><span class=na>instance</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
                <span class=c1>// standard doclet normally generates H1, H2
</span><span class=c1></span>                <span class=n>doclintOpts</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>DocLint</span><span class=o>.</span><span class=na>XIMPLICIT_HEADERS</span> <span class=o>+</span> <span class=s>&#34;2&#34;</span><span class=o>);</span>
                <span class=k>new</span> <span class=n>DocLint</span><span class=o>().</span><span class=na>init</span><span class=o>(</span><span class=n>t</span><span class=o>,</span> <span class=n>doclintOpts</span><span class=o>.</span><span class=na>toArray</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>doclintOpts</span><span class=o>.</span><span class=na>size</span><span class=o>()]));</span>
                <span class=n>comp</span><span class=o>.</span><span class=na>keepComments</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>}</span>

        <span class=c1>//HCZ：如果有待编译的java文件列表，则...
</span><span class=c1></span>        <span class=n>fileManager</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>JavaFileManager</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>

        <span class=k>if</span> <span class=o>(!</span><span class=n>files</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
            <span class=c1>// add filenames to fileObjects
</span><span class=c1></span>            <span class=c1>//HCZ：这里为啥又要初始化一次JavaCompiler？
</span><span class=c1></span>            <span class=n>comp</span> <span class=o>=</span> <span class=n>JavaCompiler</span><span class=o>.</span><span class=na>instance</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
            <span class=c1>//HCZ：待研究，啥是otherFiles？
</span><span class=c1></span>            <span class=n>List</span><span class=o>&lt;</span><span class=n>JavaFileObject</span><span class=o>&gt;</span> <span class=n>otherFiles</span> <span class=o>=</span> <span class=n>List</span><span class=o>.</span><span class=na>nil</span><span class=o>();</span>
            <span class=n>JavacFileManager</span> <span class=n>dfm</span> <span class=o>=</span> <span class=o>(</span><span class=n>JavacFileManager</span><span class=o>)</span><span class=n>fileManager</span><span class=o>;</span>
            <span class=k>for</span> <span class=o>(</span><span class=n>JavaFileObject</span> <span class=n>fo</span> <span class=o>:</span> <span class=n>dfm</span><span class=o>.</span><span class=na>getJavaFileObjectsFromFiles</span><span class=o>(</span><span class=n>files</span><span class=o>))</span>
                <span class=n>otherFiles</span> <span class=o>=</span> <span class=n>otherFiles</span><span class=o>.</span><span class=na>prepend</span><span class=o>(</span><span class=n>fo</span><span class=o>);</span>
            <span class=k>for</span> <span class=o>(</span><span class=n>JavaFileObject</span> <span class=n>fo</span> <span class=o>:</span> <span class=n>otherFiles</span><span class=o>)</span>
                <span class=n>fileObjects</span> <span class=o>=</span> <span class=n>fileObjects</span><span class=o>.</span><span class=na>prepend</span><span class=o>(</span><span class=n>fo</span><span class=o>);</span>
        <span class=o>}</span>
        <span class=c1>//HCZ：调用JavaCompiler#compile方法，里面有机关，详见那边的标注
</span><span class=c1></span>        <span class=n>comp</span><span class=o>.</span><span class=na>compile</span><span class=o>(</span><span class=n>fileObjects</span><span class=o>,</span>
                     <span class=n>classnames</span><span class=o>.</span><span class=na>toList</span><span class=o>(),</span>
                     <span class=n>processors</span><span class=o>);</span>

        <span class=k>if</span> <span class=o>(</span><span class=n>log</span><span class=o>.</span><span class=na>expectDiagKeys</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>log</span><span class=o>.</span><span class=na>expectDiagKeys</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
                <span class=n>log</span><span class=o>.</span><span class=na>printRawLines</span><span class=o>(</span><span class=s>&#34;all expected diagnostics found&#34;</span><span class=o>);</span>
                <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>OK</span><span class=o>;</span>
            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
                <span class=n>log</span><span class=o>.</span><span class=na>printRawLines</span><span class=o>(</span><span class=s>&#34;expected diagnostic keys not found: &#34;</span> <span class=o>+</span> <span class=n>log</span><span class=o>.</span><span class=na>expectDiagKeys</span><span class=o>);</span>
                <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>ERROR</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>}</span>

        <span class=k>if</span> <span class=o>(</span><span class=n>comp</span><span class=o>.</span><span class=na>errorCount</span><span class=o>()</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span>
            <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>ERROR</span><span class=o>;</span>
    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
    <span class=err>…………</span>
<span class=o>}</span>   
</code></pre></td></tr></table></div></div><ul><li>收尾工作：各种异常捕获后的收尾工作</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=n>Result</span> <span class=nf>compile</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>,</span>
                      <span class=n>String</span><span class=o>[]</span> <span class=n>classNames</span><span class=o>,</span>
                      <span class=n>Context</span> <span class=n>context</span><span class=o>,</span>
                      <span class=n>List</span><span class=o>&lt;</span><span class=n>JavaFileObject</span><span class=o>&gt;</span> <span class=n>fileObjects</span><span class=o>,</span>
                      <span class=n>Iterable</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Processor</span><span class=o>&gt;</span> <span class=n>processors</span><span class=o>)</span>
<span class=o>{</span>
    <span class=err>…………</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>ioMessage</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
        <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>SYSERR</span><span class=o>;</span>
    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>OutOfMemoryError</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>resourceMessage</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
        <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>SYSERR</span><span class=o>;</span>
    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>StackOverflowError</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>resourceMessage</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
        <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>SYSERR</span><span class=o>;</span>
    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>FatalError</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>feMessage</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
        <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>SYSERR</span><span class=o>;</span>
    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>AnnotationProcessingError</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>apiMode</span><span class=o>)</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>ex</span><span class=o>.</span><span class=na>getCause</span><span class=o>());</span>
        <span class=n>apMessage</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
        <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>SYSERR</span><span class=o>;</span>
    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ClientCodeException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
        <span class=c1>// as specified by javax.tools.JavaCompiler#getTask
</span><span class=c1></span>        <span class=c1>// and javax.tools.JavaCompiler.CompilationTask#call
</span><span class=c1></span>        <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>ex</span><span class=o>.</span><span class=na>getCause</span><span class=o>());</span>
    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>PropagatedException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>throw</span> <span class=n>ex</span><span class=o>.</span><span class=na>getCause</span><span class=o>();</span>
    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
        <span class=c1>// Nasty.  If we&#39;ve already reported an error, compensate
</span><span class=c1></span>        <span class=c1>// for buggy compiler error recovery by swallowing thrown
</span><span class=c1></span>        <span class=c1>// exceptions.
</span><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>comp</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>comp</span><span class=o>.</span><span class=na>errorCount</span><span class=o>()</span> <span class=o>==</span> <span class=n>0</span> <span class=o>||</span>
            <span class=n>options</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>options</span><span class=o>.</span><span class=na>isSet</span><span class=o>(</span><span class=s>&#34;dev&#34;</span><span class=o>))</span>
            <span class=n>bugMessage</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
        <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>ABNORMAL</span><span class=o>;</span>
    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>comp</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=n>comp</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ClientCodeException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
                <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>ex</span><span class=o>.</span><span class=na>getCause</span><span class=o>());</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=n>filenames</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
        <span class=n>options</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
    <span class=o>}</span>
    <span class=k>return</span> <span class=n>Result</span><span class=o>.</span><span class=na>OK</span><span class=o>;</span>
    <span class=err>…………</span>
<span class=o>}</span>   
</code></pre></td></tr></table></div></div><h3 id=与周边类的关系-1>与周边类的关系</h3><p>从前文的源码分析可以看到，当前类最终是调用<code>JavaCompiler#compile方法</code>实现的前端编译过程，而<code>JavaCompiler</code>有依赖了<code>Options类</code>读写javac的命令行配置参数。</p><p><img src=/Java%E6%8B%BE%E9%81%97/%E3%80%90%E5%AE%8F%E8%A7%82%E3%80%91%E5%A6%82%E4%BD%95%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20211012233450136.png alt=image-20211012233450136></p><h1 id=4总结>4.总结</h1><ul><li>本文表达了笔者的对于深入理解JVM的一种观点：即，通过阅读OpenJDK源码才能达到真正的理解JVM。</li><li>本文解析了javac入口部分的源码，为后续进一步理解JVM的前端编译过程奠定了基础。</li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>猴王无敌</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-10-12</span></p><p class=copyright-item><span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=/weixin.png>
<span>微信打赏</span></label>
<label class=qr-code-image for=reward><img class=image src=/alipay.png>
<span>支付宝打赏</span></label></div></div><footer class=post-footer><div class=post-tags><a href=https://jherculesqz.github.io/tags/java%E6%8B%BE%E9%81%97-%E5%AE%8F%E8%A7%82/>Java拾遗-宏观</a></div><nav class=post-nav><a class=next href=/post/java%E6%8B%BE%E9%81%97/java%E6%96%B0%E7%89%B9%E6%80%A7-0-%E5%AD%A6%E4%B9%A0java%E6%96%B0%E7%89%B9%E6%80%A7%E5%A6%82%E4%BD%95%E5%BF%AB%E4%BA%BA%E4%B8%80%E6%AD%A5/><span class="next-text nav-default">【Java新特性】-0-学习Java新特性，如何快人一步</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"/></svg></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=icon-links><a href=mailto:JHercules_qz@qq.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408 1361.641813S1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523L83.726336 1024H682.532949 753.579947 1348.948139L1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955C777.248 802.205449 742.347691 811.03081 718.063616 811.603883z"/></svg></a><a href=https://github.com/JHerculesqz rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg></a><a href=https://jherculesqz.github.io/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a></span>
<span class=copyright-year>&copy;
2021
<span class=heart><i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg></i></span><span class=author>猴王无敌</span></span>
<span id=busuanzi_container>访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span></span></div></footer><div class=back-to-top id=back-to-top><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg></i></div></div><script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script><script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script><script type=text/javascript src=/js/load-photoswipe.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>